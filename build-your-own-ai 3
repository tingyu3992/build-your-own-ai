import numpy as np
import pandas as pd
from sklearn.metrics.pairwise import cosine_similarity

# è¼‰å…¥åµŒå…¥èˆ‡æ¨™é¡Œ
embeddings = np.load('movie_embeddings.npy')
titles = pd.read_csv('movie_titles.csv')['title'].tolist()

def recommend_top_k(query_embedding, embeddings, titles, k=5):
    """
    æ ¹æ“šè¼¸å…¥åµŒå…¥å‘é‡è¨ˆç®—ç›¸ä¼¼åº¦ä¸¦å›å‚³å‰ k å€‹æœ€ç›¸ä¼¼é …ç›®

    åƒæ•¸ï¼š
        query_embedding (np.array): æŸ¥è©¢å‘é‡ (1, 384)
        embeddings (np.array): æ‰€æœ‰é …ç›®çš„åµŒå…¥ (N, 384)
        titles (List[str]): å°æ‡‰çš„é …ç›®æ¨™é¡Œ
        k (int): è¦å›å‚³çš„ç›¸ä¼¼é …ç›®æ•¸é‡

    å›å‚³ï¼š
        List[Tuple[æ¨™é¡Œ, ç›¸ä¼¼åº¦]]
    """
    # è¨ˆç®—ç›¸ä¼¼åº¦ï¼ˆ1 x N å‘é‡ï¼‰
    sims = cosine_similarity([query_embedding], embeddings)[0]

    # å–å¾—ç›¸ä¼¼åº¦æ’åºå‰ K åç´¢å¼•
    top_k_indices = np.argsort(sims)[::-1][:k]

    # å›å‚³æ¨™é¡Œèˆ‡ç›¸ä¼¼åº¦
    return [(titles[i], round(sims[i], 4)) for i in top_k_indices]

# ç¯„ä¾‹æ¸¬è©¦ï¼šä½¿ç”¨è³‡æ–™é›†ä¸­ç¬¬ 10 ç­†åŠ‡æƒ…åšç‚ºæŸ¥è©¢å‘é‡
query_index = 10
query_vector = embeddings[query_index]
query_title = titles[query_index]

print(f"\nğŸ¯ æ ¹æ“šé›»å½±ã€Š{query_title}ã€‹æ¨è–¦ï¼š")
results = recommend_top_k(query_vector, embeddings, titles)

for i, (title, score) in enumerate(results, 1):
    print(f"{i}. {title} (ç›¸ä¼¼åº¦: {score})")
